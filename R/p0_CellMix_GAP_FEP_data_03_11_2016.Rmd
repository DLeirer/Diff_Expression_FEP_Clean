---
title: "CellMix"
author: "DJL"
date: "17/02/2016"
output:
  word_document:
    fig_height: 6
---

#CellMix approach:

##Install and load Libraries:
```{r Libraries, message=FALSE,warning=FALSE}

#source("http://bioconductor.org/biocLite.R")
#biocLite('CellMix', siteRepos = 'http://web.cbio.uct.ac.za/~renaud/CRAN')

library(CellMix)
library(lumi)
library(reshape)
library(plyr)
library(dplyr)
library(ggplot2)

```


##Set directories:
```{r directory}

data_dir <-"./data/"
P0_output_dir <-"./P0_Characterise/output/"
P0_figs_dir <-"./P0_Characterise/figs/"

```

##Load gene expression data (Should be LumiBatch object):
```{r}

lumidata<-"GAP_FEP_Full_Gene_Expression_Data.RData"
load(paste(data_dir,lumidata,sep=""))


```

##GED BLOOD ABBAS WHOLE BLOOD:
gedBlood is a meta function. It uses a standard set of functions included in CellMix to generate results. It seems to be able to handle nuIDs. gedBlood automatically adjusts gene IDs so I suspect it searches the LumiBatch file for IDs it recognises and matches them with whatever dataset it uses. 
In this case the ABBAS blood atlas is used. 
CLsubset allows you to choose between WB for whole blood and PBMCs. 
verbose simply tells you the steps it takes which would usually have to be performed manually in the package. 
These settings just use a linear model based on gene expression values for different cell types from the ABBAS blood atlas (Abbas et al. 2009)* to estimate cell proportions in each sample.
This is after preprocessing, so we only use the approx. 5000 probes that passed QC.
Cellmix has a lot more functions and ways to estimate cell proportions, but after looking through all of it, you could probably make it into a study by itself. Some of the methods seem to be quite computationally intensive. See table 2 on page 26 [here](http://web.cbio.uct.ac.za/~renaud/CRAN/web/CellMix/vignettes/Introduction.pdf) for list of approaches. 

^*Abbas AR, Wolslegel K, Seshasayee D, Modrusan Z and Clark HF (2009). "Deconvolution of blood microarray data identifies cellular activation patterns in systemic lupus erythematosus."^

###GEDBlood Function:
```{r}
res_all <- gedBlood(eset_bg_log2_rsn_SVA_Good, CLsubset = "WB", verbose = TRUE)


#Extract cell proportions from res_all
wbloodprop<-coef(res_all)

#Remove rows with sum of 0. Rows represent cell types. If a cell type has a sum of 0 across all samples I exclude it. 

reduced_props<-wbloodprop[apply(wbloodprop, 1, function(x) !all(x==0)),]

```

"reduced_probs" contains all the releveant cell proportions and is written into a CSV file which I later merge with my phenotype data in my LIMMA script. 
They are then added as covariates. 


##Check for differences between cases and controls:
Here I split the blood proportion data in case and control so I can plot it using ggplot2. 

```{r}

#Get Case Control Status
pheno_data <- pData(eset_bg_log2_rsn_SVA_Good)

#transform data
reduced_props<-data.frame(t(reduced_props))
#check samples in correct order
all.equal(rownames(reduced_props),rownames(pheno_data))
#add pheno data
reduced_probs_pheno<-cbind(reduced_props,pheno_data)
names(reduced_probs_pheno)

#Melt Data for ggplot
mwbdata <- melt(reduced_probs_pheno, id=c(12:72))
head(mwbdata)

#Graph data
bloodgraph<-ggplot(mwbdata,aes(x=variable,y=value,fill=Phenotype), ) +  
  geom_boxplot()+
  ggtitle("Blood Cell Proportions")+
  theme(plot.title = element_text(lineheight=.8, face="bold"))+
  xlab("Cell Type")+ylab("Percentage for each individual")
bloodgraph


#select plots to make
plotnames<-names(reduced_probs_pheno[c("Phenotype","Gender","Tobacco","Ethnicity","Medication","tech.Sentrix.Barcode","tech.Date_Washing_and_scanning","tech.Date_Quantitation_by_RiboGreen","tech.SampleSection")])

names(reduced_probs_pheno)

#make function
f <- function(mwbdata, fill_name) {
    bloodgraph<-ggplot(mwbdata,aes_string(x="variable",y="value",fill=fill_name), ) +  
    geom_boxplot()+
    ggtitle("Blood Cell Proportions")+
    theme(plot.title = element_text(lineheight=.8, face="bold"))+
    xlab("Cell Type")+ylab("Percentage for each individual")
    print(bloodgraph)
}

#Create loop for all variables and save
CellMixgraph<-"Cell_Mix_Boxplots.pdf"
pdf(paste(P0_figs_dir,CellMixgraph,sep=""))
for (fill_number in 1:length(plotnames)){
  fill_name<-plotnames[fill_number]
  f(mwbdata,fill_name)  
  
}
dev.off()

  
```

##Statistics:
```{r, tidy=TRUE}

names(mwbdata)
stats_pheno<-ddply(mwbdata,"variable",
      function(x) {
          w <- wilcox.test(value~Phenotype,data=x)
          with(w,data.frame(statistic,p.value))
      })

stats_gender<-ddply(mwbdata,"variable",
      function(x) {
          w <- wilcox.test(value~Gender,data=x)
          with(w,data.frame(statistic,p.value))
      })

stats_pheno[,c(1,3)]




```

